# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-011
# VERSION: 1.0

## 1. Summary

- Title: Article Import & Paste from DOCX
- Type: functional
- Priority: medium
- Status: implemented (partial - DOCX deferred)

## 2. Description

Enable users to import articles from Microsoft Word (DOCX) format and paste rich text content directly from Word into the Markdown editor. This feature streamlines content migration and authoring workflows.

## 3. Functional Requirements

### 3.1. DOCX File Upload & Conversion
- **Upload Interface**: 
  - "Import from DOCX" button in Article Editor.
  - File picker accepts `.docx` files only.
- **Conversion Process**:
  - Backend receives DOCX file.
  - Extracts text content and converts to Markdown.
  - Extracts embedded images from DOCX archive (`word/media/`).
  - Uploads images to storage.
  - Replaces image references in Markdown with public URLs.
- **Output**: Populate Article `body` field with converted Markdown.

### 3.2. Paste from Word (Rich Text)
- **Paste Detection**:
  - Listen to `paste` event in Markdown editor.
  - Detect `text/html` format (Word clipboard format).
- **Conversion Process**:
  - Convert HTML to Markdown (client-side using `turndown.js`).
  - Extract base64-encoded images from HTML.
  - Upload images to backend → Receive URLs.
  - Replace image placeholders in Markdown with uploaded URLs.
- **User Experience**: Seamless paste; images appear inline immediately.

### 3.3. Image Storage Strategy

**MVP (Local Storage)**:
- Store images in `api/uploads/articles/{article_id}/`.
- Serve via endpoint: `GET /api/uploads/articles/{article_id}/{filename}`.
- File naming: `{timestamp}_{original_name}` to avoid collisions.

**Future (Cloud Storage)**:
- Migrate to S3/Cloudflare R2.
- Use signed URLs for security.

## 4. Technical Specifications

### 4.1. Backend (Go)
- **Library**: Use `pandoc` (via Go wrapper) or implement custom DOCX parser.
- **Endpoint**: `POST /api/articles/import-docx`
  - **Request**: `multipart/form-data` with DOCX file.
  - **Response**: `{ "markdown": "...", "images": ["url1", "url2"] }`.
- **Image Upload Endpoint**: `POST /api/uploads/articles/{article_id}/images`
  - **Request**: `multipart/form-data` with image files.
  - **Response**: `{ "urls": ["https://..."] }`.

### 4.2. Frontend (Next.js)
- **DOCX Import**:
  - File input → Upload to backend → Populate editor.
- **Paste Handler**:
  - Intercept `paste` event.
  - Use `turndown.js` for HTML → Markdown conversion.
  - Upload images via `fetch` to backend.
  - Insert final Markdown into editor.

## 5. Non-Functional Requirements
- **Performance**: DOCX conversion < 2s for files up to 5MB.
- **Security**: 
  - Validate file type (magic bytes, not just extension).
  - Sanitize HTML to prevent XSS.
  - Limit file size (10MB max).
- **Storage**: Images stored with unique names to prevent overwrites.

## 6. Acceptance Criteria
- AC-1: User can upload a DOCX file and see Markdown in the editor.
- AC-2: Embedded images in DOCX are extracted and accessible via URLs.
- AC-3: User can paste from Word and images appear inline.
- AC-4: Image URLs are valid and images load correctly.
- AC-5: Invalid files (non-DOCX) are rejected with clear error messages.

## 7. Traceability
- **Related Modules**: MOD-BE-Articles, MOD-FE-Articles, MOD-BE-Uploads
- **Dependencies**: REQ-010 (Articles)
- **Related Tests**: TC-E2E-Articles-Import, TC-FUNC-DOCX-Conversion

## 8. Implementation Notes
- **Phase 1 (MVP)**: ✅ Image upload endpoint + paste from Word support.
- **Phase 2**: ❌ DOCX upload (deferred - requires Pandoc dependency).
- **Phase 3**: Cloud storage migration (future).

## 9. Implementation Details
- **Backend**: `api/internal/modules/uploads/handler.go` (image upload, validation, serving)
- **Frontend**: `web/src/app/components/articles/ArticleEditor.tsx` (paste handler, image upload button)
- **Libraries**: `turndown` (HTML→Markdown conversion)
- **Tests**: `web/tests/article-import.spec.ts`
- **Storage**: Local filesystem (`./uploads/images/`)

