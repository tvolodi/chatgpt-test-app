# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-017
# VERSION: 1.0

## 1. Summary

- Title: Content Search Functionality
- Type: Functional
- Priority: medium
- Status: **implemented**

## 2. Description

Users need to search across articles to find content by keywords. Search should match against article titles and body content. Results should be ranked by relevance and support pagination. This feature improves content discoverability on the platform.

## 3. User Stories

- **US-17.1**: As a visitor, I want to search for articles by keyword so I can find relevant content.
- **US-17.2**: As a visitor, I want search results to show matching articles with highlighted keywords.
- **US-17.3**: As a visitor, I want to see how many results match my search query.
- **US-17.4**: As a visitor, I want to filter search results by category or tags.
- **US-17.5**: As a visitor, I want search suggestions as I type (autocomplete).

## 4. Technical Specifications

### 4.1 Backend API (To Be Implemented)

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/articles/search?q={query}` | No | Search articles by keyword |

### 4.2 Request/Response Schemas

**GET /api/articles/search**

Query Parameters:
- `q` (required): Search query string
- `category_id` (optional): Filter by category
- `tags` (optional, repeatable): Filter by tags
- `page` (optional, default 1): Page number
- `limit` (optional, default 10): Results per page

```json
Response (200):
{
  "articles": [
    {
      "id": "uuid",
      "title": "Article Title with <mark>keyword</mark>",
      "excerpt": "...snippet with <mark>keyword</mark> highlighted...",
      "slug": "article-slug",
      "category_id": "uuid",
      "published_at": "datetime",
      "tags": ["tag1", "tag2"]
    }
  ],
  "total": 42,
  "page": 1,
  "limit": 10,
  "query": "keyword"
}
```

### 4.3 Database Approach

**Option A: PostgreSQL Full-Text Search (Recommended for MVP)**
```sql
-- Add tsvector column to articles
ALTER TABLE articles ADD COLUMN search_vector tsvector;

-- Create index
CREATE INDEX articles_search_idx ON articles USING GIN(search_vector);

-- Update trigger
CREATE TRIGGER articles_search_update
  BEFORE INSERT OR UPDATE ON articles
  FOR EACH ROW EXECUTE FUNCTION
    tsvector_update_trigger(search_vector, 'pg_catalog.english', title, body);

-- Search query
SELECT * FROM articles
WHERE search_vector @@ plainto_tsquery('english', $1)
  AND status = 'PUBLISHED'
ORDER BY ts_rank(search_vector, plainto_tsquery('english', $1)) DESC;
```

**Option B: Elasticsearch (Future Scalability)**
- External Elasticsearch instance
- Sync articles on create/update/delete
- More advanced ranking and features

### 4.4 Frontend Components

| Component | Location | Description |
|-----------|----------|-------------|
| `SearchBar` | `web/src/components/common/SearchBar.tsx` | Search input with suggestions |
| `SearchResults` | `web/src/app/[locale]/search/page.tsx` | Search results page |
| `SearchResultItem` | `web/src/components/search/SearchResultItem.tsx` | Individual result card |

### 4.5 Frontend Routes

| Route | Description |
|-------|-------------|
| `/[locale]/search?q={query}` | Search results page |

## 5. Wireframes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                    [ğŸ” Search...                 ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Search Results for "artificial intelligence"                â”‚
â”‚ 42 results found                                            â”‚
â”‚                                                             â”‚
â”‚ Filters: [All Categories â–¼] [Tags: AI, ML Ã—]               â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ The Future of <mark>Artificial Intelligence</mark>      â”‚ â”‚
â”‚ â”‚ ...explores how <mark>AI</mark> is transforming...      â”‚ â”‚
â”‚ â”‚ ğŸ“ Technology | ğŸ·ï¸ AI, Future | ğŸ“… Jan 15, 2025       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Machine Learning and <mark>AI</mark> in Healthcare     â”‚ â”‚
â”‚ â”‚ ...applications of <mark>artificial intelligence</mark> â”‚ â”‚
â”‚ â”‚ ğŸ“ Health | ğŸ·ï¸ AI, Healthcare | ğŸ“… Jan 10, 2025       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚                    [1] [2] [3] ... [5]                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. Acceptance Criteria

### AC-17.1: Search Input
- **AC-17.1.1**: Search bar is accessible from header on all pages
- **AC-17.1.2**: Enter key or search button triggers search
- **AC-17.1.3**: Search query is reflected in URL (shareable)
- **AC-17.1.4**: Minimum query length is 2 characters
- **AC-17.1.5**: Search input is debounced (300ms) for autocomplete

### AC-17.2: Search Results
- **AC-17.2.1**: Results display article title with keyword highlighted
- **AC-17.2.2**: Results display excerpt with keyword highlighted
- **AC-17.2.3**: Results display category, tags, and publish date
- **AC-17.2.4**: Clicking a result navigates to article detail page
- **AC-17.2.5**: Total result count is displayed
- **AC-17.2.6**: Empty state shows "No results found" message

### AC-17.3: Filters
- **AC-17.3.1**: Results can be filtered by category
- **AC-17.3.2**: Results can be filtered by tags
- **AC-17.3.3**: Filters are reflected in URL parameters
- **AC-17.3.4**: Clearing filters shows all results for query

### AC-17.4: Pagination
- **AC-17.4.1**: Results are paginated (10 per page default)
- **AC-17.4.2**: Pagination controls shown when results > page size
- **AC-17.4.3**: Current page is highlighted
- **AC-17.4.4**: Page number is reflected in URL

### AC-17.5: Performance
- **AC-17.5.1**: Search returns results within 500ms
- **AC-17.5.2**: Loading state shown while searching
- **AC-17.5.3**: Only published articles appear in results

### AC-17.6: i18n Support
- **AC-17.6.1**: All UI text uses translation keys
- **AC-17.6.2**: Search works across all languages
- **AC-17.6.3**: Placeholder text is localized

## 7. Dependencies

| REQ_ID | Description |
|--------|-------------|
| REQ-010 | Articles CRUD (searchable content) |
| REQ-012 | Public article list (result format) |

## 9. Test Traceability

| Test ID | Type | Acceptance Criteria |
|---------|------|---------------------|
| TC-E2E-017.1 | E2E | AC-17.1.1, AC-17.1.2, AC-17.1.3 |
| TC-E2E-017.2 | E2E | AC-17.2.1, AC-17.2.2, AC-17.2.4, AC-17.2.6 |
| TC-E2E-017.3 | E2E | AC-17.3.1, AC-17.3.2, AC-17.3.3 |
| TC-INT-017.1 | Integration | Search ranking and relevance |
| web/tests/req-017-search.spec.ts | E2E | All AC-17.x implemented |

## 9. Implementation Notes

### For AI Agents

1. **Phase 1 (MVP)**: Use PostgreSQL full-text search
2. **Backend First**: Implement search API before frontend
3. **Migration Required**: Add `search_vector` column and trigger
4. **Highlight Generation**: Use `ts_headline()` for excerpts
5. **Locale Consideration**: May need multi-language search config

### Go Implementation Snippet

```go
// Search handler
func (h *Handler) handleSearch(w http.ResponseWriter, r *http.Request) {
    query := r.URL.Query().Get("q")
    if len(query) < 2 {
        http.Error(w, "query too short", http.StatusBadRequest)
        return
    }
    
    results, total, err := h.service.Search(query, filters, limit, offset)
    // ...
}

// Repository search method
func (r *Repository) Search(query string, limit, offset int) ([]Article, int, error) {
    sql := `
        SELECT id, title, 
               ts_headline('english', body, plainto_tsquery($1)) as excerpt,
               slug, category_id, published_at
        FROM articles
        WHERE search_vector @@ plainto_tsquery('english', $1)
          AND status = 'PUBLISHED'
        ORDER BY ts_rank(search_vector, plainto_tsquery('english', $1)) DESC
        LIMIT $2 OFFSET $3
    `
    // ...
}
```
