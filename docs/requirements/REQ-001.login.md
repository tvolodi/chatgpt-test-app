# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-001
# VERSION: 2.0

## 1. Summary

- Title: User login and registration via Keycloak
- Type: functional
- Priority: high
- Status: approved

## 2. Description

Users authenticate via the Keycloak Identity Provider. The application delegates authentication to Keycloak using the OIDC Authorization Code flow with PKCE (Proof Key for Code Exchange). The frontend uses a **public client** configuration (no client secret) as recommended for browser-based applications.

New users can self-register through Keycloak's registration page, which is accessible from the login screen.

## 3. User Story

- "As a registered user, I want to be redirected to a secure login page so that I can access my personal dashboard without sharing my password directly with the application."
- "As a new user, I want to create an account through a registration page so that I can access the platform without manual admin approval."

## 4. Acceptance Criteria

### Login Flow
- AC-1: When the user clicks "Login", they are redirected to the Keycloak login page.
- AC-2: After successful authentication on Keycloak, the user is redirected back to the application dashboard.
- AC-3: The application receives and validates the ID Token and Access Token using PKCE flow.
- AC-4: If authentication fails or is cancelled, the user is returned to the landing page with an error message.
- AC-5: The Keycloak client is configured as a public client (no client secret required).

### Registration Flow
- AC-6: The Keycloak login page displays a "Register" or "Sign up" link.
- AC-7: Clicking the registration link navigates to Keycloak's registration form.
- AC-8: New users can create an account by providing email, username, and password.
- AC-9: After successful registration, the user is automatically logged in and redirected to the application dashboard.
- AC-10: Registration requires email verification (configurable in Keycloak).

### Logout Flow
- AC-11: When the user is authenticated, the "Sign in" button in the navigation is replaced with "Logout".
- AC-12: Clicking "Logout" signs the user out of the application and Keycloak.
- AC-13: After logout, the user is redirected to the landing page (/).
- AC-14: The navigation displays "Sign in" again after logout.

## 4.1. UI Elements and User Actions

### Application Login Page (`/login`)

**UI Elements:**
- **Page Title**: "Welcome Back" (h1, centered)
- **Subtitle**: "Sign in to access your dashboard" (paragraph, centered, gray text)
- **Primary Button**: "Sign In with Keycloak" (full-width, blue background, white text)
- **Container**: White card with rounded corners and shadow, centered on gray background

**User Actions:**
1. User navigates to `/login` (directly or via "Sign in" link in navigation)
2. User clicks "Sign In with Keycloak" button
3. Application initiates OIDC flow and redirects to Keycloak

**Visual Design:**
- Minimalist, centered layout
- Blue (#3A9BDC) for primary actions
- Responsive design (works on mobile and desktop)

### Keycloak Login Page (Hosted by Keycloak)

**UI Elements:**
- **Page Title**: "Sign in to your account" or realm-specific title
- **Username/Email Field**: Text input for username or email
- **Password Field**: Password input with show/hide toggle
- **Login Button**: Primary button to submit credentials
- **Register Link**: "Register" or "Create an account" link (bottom of form)
- **Forgot Password Link**: "Forgot Password?" link (optional, if enabled)
- **Remember Me Checkbox**: Optional checkbox to persist session

**User Actions - Login Flow:**
1. User enters username/email in the username field
2. User enters password in the password field
3. User clicks "Login" button
4. Keycloak validates credentials
5. On success: User is redirected back to application with authorization code
6. Application exchanges code for tokens and redirects to `/dashboard`

**User Actions - Registration Flow:**
1. User clicks "Register" link at bottom of login form
2. User is navigated to Keycloak registration page

### Keycloak Registration Page (Hosted by Keycloak)

**UI Elements:**
- **Page Title**: "Register" or "Create your account"
- **Email Field**: Text input for email address (required)
- **Username Field**: Text input for username (required)
- **First Name Field**: Text input for first name (optional)
- **Last Name Field**: Text input for last name (optional)
- **Password Field**: Password input with strength indicator
- **Confirm Password Field**: Password input for confirmation
- **Register Button**: Primary button to submit registration
- **Back to Login Link**: Link to return to login page

**User Actions - Registration Flow:**
1. User fills in email address
2. User chooses a username
3. User enters first name and last name (optional)
4. User creates a password (must meet strength requirements)
5. User confirms password
6. User clicks "Register" button
7. Keycloak creates account and validates email (if enabled)
8. User is automatically logged in
9. User is redirected back to application with authorization code
10. Application exchanges code for tokens and redirects to `/dashboard`

### Navigation Integration

**Main Navigation Bar:**
- **"Sign in" Link**: Located in top-right navigation
  - **URL**: `/login`
  - **Visibility**: Shown only when user is not authenticated
  - **Action**: Navigates to application login page

**Main Navigation Bar (Authenticated):**
- **"Dashboard" Link**: Located in top-right navigation
  - **URL**: `/dashboard`
  - **Visibility**: Shown only when user is authenticated
  - **Action**: Navigates to user dashboard
- **"Logout" Button**: Located next to Dashboard link
  - **Action**: Signs user out and redirects to main page

**Post-Authentication:**
- "Sign in" link is replaced with "Dashboard" link and "Logout" button
- User can access protected routes (e.g., `/dashboard`)
- Dashboard logo is clickable and returns to main page

### Error Handling UI

**Failed Login:**
- Keycloak displays error message: "Invalid username or password"
- User remains on Keycloak login page
- User can retry or click "Forgot Password"

**Cancelled Login:**
- User clicks browser back button or closes Keycloak page
- Application redirects to landing page (`/`)
- Optional: Display info message "Login was cancelled"

**Registration Errors:**
- Keycloak displays field-specific errors:
  - "Email already exists"
  - "Username already taken"
  - "Password too weak"
  - "Passwords do not match"
- User corrects errors and resubmits

### Session Management

**Active Session:**
- User's session is maintained via JWT tokens
- Access token stored in session (server-side)
- Refresh token used to extend session automatically

**Session Expiry:**
- When session expires, user is redirected to `/login`
- User must re-authenticate with Keycloak

## 5. Non-Functional Constraints

- Response times: Redirect to Keycloak should happen immediately (< 200ms).
- Security: Use PKCE (Proof Key for Code Exchange) for public clients. No client secret stored in browser.

## 6. Traceability

- Product Brief Feature(s): F1 (Login)
- Related Modules:
  - MOD-FE-Login
  - MOD-BE-Auth
- Related Tests:
  - TC-FUNC-001 (Token Verification)
  - TC-E2E-001 (Login Flow)
