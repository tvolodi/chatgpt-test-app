# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-001
# VERSION: 2.0

## 1. Summary

- Title: User login and registration via Keycloak
- Type: functional
- Priority: high
- Status: approved

## 2. Description

Users authenticate via the Keycloak Identity Provider. The application delegates authentication to Keycloak using the OIDC Authorization Code flow with PKCE (Proof Key for Code Exchange). The frontend uses a **public client** configuration (no client secret) as recommended for browser-based applications.

New users can self-register through Keycloak's registration page, which is accessible from the login screen.

## 3. User Story

- "As a registered user, I want to be redirected to a secure login page so that I can access my personal dashboard without sharing my password directly with the application."
- "As a new user, I want to create an account through a registration page so that I can access the platform without manual admin approval."

## 4. Acceptance Criteria

### Login Flow
- AC-1: When the user clicks "Login", they are redirected to the Keycloak login page.
- AC-2: After successful authentication on Keycloak, the user is redirected back to the application dashboard.
- AC-3: The application receives and validates the ID Token and Access Token using PKCE flow.
- AC-4: If authentication fails or is cancelled, the user is returned to the landing page with an error message.
- AC-5: The Keycloak client is configured as a public client (no client secret required).

### Registration Flow
- AC-6: The Keycloak login page displays a "Register" or "Sign up" link.
- AC-7: Clicking the registration link navigates to Keycloak's registration form.
- AC-8: New users can create an account by providing email, username, and password.
- AC-9: After successful registration, the user is automatically logged in and redirected to the application dashboard.
- AC-10: Registration requires email verification (configurable in Keycloak).

### Logout Flow
- AC-11: When the user is authenticated, the "Sign in" button in the navigation is replaced with "Logout".
- AC-12: Clicking "Logout" signs the user out of the application and Keycloak.
- AC-13: After logout, the user is redirected to the landing page (/).
- AC-14: The navigation displays "Sign in" again after logout.

### Token Refresh Flow
- AC-15: The application stores both access token and refresh token from Keycloak.
- AC-16: Before each authenticated API request, the application checks if the access token has expired.
- AC-17: If the access token has expired, the application automatically refreshes it using the refresh token.
- AC-18: If the refresh token is invalid or expired, the user is redirected to the login page.
- AC-19: Token refresh happens transparently without user interaction.

## 4.1. UI Elements and User Actions

### Application Login Page (`/login`)

**UI Elements:**
- **Page Title**: "Welcome Back" (h1, centered)
- **Subtitle**: "Sign in to access your dashboard" (paragraph, centered, gray text)
- **Primary Button**: "Sign In with Keycloak" (full-width, blue background, white text)
- **Container**: White card with rounded corners and shadow, centered on gray background

**User Actions:**
1. User navigates to `/login` (directly or via "Sign in" link in navigation)
2. User clicks "Sign In with Keycloak" button
3. Application initiates OIDC flow and redirects to Keycloak

**Visual Design:**
- Minimalist, centered layout
- Blue (#3A9BDC) for primary actions
- Responsive design (works on mobile and desktop)

### Keycloak Login Page (Hosted by Keycloak)

**UI Elements:**
- **Page Title**: "Sign in to your account" or realm-specific title
- **Username/Email Field**: Text input for username or email
- **Password Field**: Password input with show/hide toggle
- **Login Button**: Primary button to submit credentials
- **Register Link**: "Register" or "Create an account" link (bottom of form)
- **Forgot Password Link**: "Forgot Password?" link (optional, if enabled)
- **Remember Me Checkbox**: Optional checkbox to persist session

**User Actions - Login Flow:**
1. User enters username/email in the username field
2. User enters password in the password field
3. User clicks "Login" button
4. Keycloak validates credentials
5. On success: User is redirected back to application with authorization code
6. Application exchanges code for tokens and redirects to `/dashboard`

**User Actions - Registration Flow:**
1. User clicks "Register" link at bottom of login form
2. User is navigated to Keycloak registration page

### Keycloak Registration Page (Hosted by Keycloak)

**UI Elements:**
- **Page Title**: "Register" or "Create your account"
- **Email Field**: Text input for email address (required)
- **Username Field**: Text input for username (required)
- **First Name Field**: Text input for first name (optional)
- **Last Name Field**: Text input for last name (optional)
- **Password Field**: Password input with strength indicator
- **Confirm Password Field**: Password input for confirmation
- **Register Button**: Primary button to submit registration
- **Back to Login Link**: Link to return to login page

**User Actions - Registration Flow:**
1. User fills in email address
2. User chooses a username
3. User enters first name and last name (optional)
4. User creates a password (must meet strength requirements)
5. User confirms password
6. User clicks "Register" button
7. Keycloak creates account and validates email (if enabled)
8. User is automatically logged in
9. User is redirected back to application with authorization code
10. Application exchanges code for tokens and redirects to `/dashboard`

### Navigation Integration

**Main Navigation Bar:**
- **"Sign in" Link**: Located in top-right navigation
  - **URL**: `/login`
  - **Visibility**: Shown only when user is not authenticated
  - **Action**: Navigates to application login page

**Main Navigation Bar (Authenticated):**
- **"Dashboard" Link**: Located in top-right navigation
  - **URL**: `/dashboard`
  - **Visibility**: Shown only when user is authenticated
  - **Action**: Navigates to user dashboard
- **"Logout" Button**: Located next to Dashboard link
  - **Action**: Signs user out and redirects to main page

**Post-Authentication:**
- "Sign in" link is replaced with "Dashboard" link and "Logout" button
- User can access protected routes (e.g., `/dashboard`)
- Dashboard logo is clickable and returns to main page

### Error Handling UI

**Failed Login:**
- Keycloak displays error message: "Invalid username or password"
- User remains on Keycloak login page
- User can retry or click "Forgot Password"

**Cancelled Login:**
- User clicks browser back button or closes Keycloak page
- Application redirects to landing page (`/`)
- Optional: Display info message "Login was cancelled"

**Registration Errors:**
- Keycloak displays field-specific errors:
  - "Email already exists"
  - "Username already taken"
  - "Password too weak"
  - "Passwords do not match"
- User corrects errors and resubmits

### Session Management

**Active Session:**
- User's session is maintained via JWT tokens
- Access token and refresh token stored in session (server-side)
- Access token has short expiration (typically 5-15 minutes)
- Refresh token has longer expiration (typically 30 days)
- Refresh token used to extend session automatically

**Token Refresh:**
- Application checks token expiration before each authenticated request
- If access token is expired but refresh token is valid:
  - Application calls Keycloak token endpoint with refresh token
  - New access token and refresh token are obtained
  - Session is updated with new tokens
  - Original request proceeds with new access token
- Token refresh is transparent to the user (no UI interruption)

**Session Expiry:**
- When both access and refresh tokens expire, user is redirected to `/login`
- User must re-authenticate with Keycloak
- Error message displayed: "Your session has expired. Please sign in again."

## 5. Non-Functional Constraints

- Response times: Redirect to Keycloak should happen immediately (< 200ms).
- Security: Use PKCE (Proof Key for Code Exchange) for public clients. No client secret stored in browser.

## 6. Implementation Status

### Backend Implementation
- ✅ **NextAuth Configuration** (`web/src/app/api/auth/[...nextauth]/route.ts`)
  - Keycloak OIDC provider configured with PKCE support
  - Token storage in JWT with automatic refresh
  - Public client configuration (AC-5 verified)
  - Handles all token refresh flows (AC-15 through AC-19)

- ✅ **Auth Middleware** (`api/internal/auth/middleware.go`)
  - JWT token validation using Keycloak OIDC verifier
  - Bearer token extraction and verification
  - User context propagation

- ✅ **CORS & Security** (`api/internal/http/server/server.go`)
  - CORS headers configured for localhost:3000 and localhost:4000
  - Authorization header passthrough enabled

### Frontend Implementation
- ✅ **Login Page** (`web/src/app/[locale]/login/page.tsx`)
  - Centered card layout with logo, title, subtitle
  - "Sign In with Keycloak" button with Walnut Retro styling
  - Responsive design for mobile and desktop

- ✅ **Navigation Component** (`web/src/app/components/Navigation.tsx`)
  - Shows "Sign in" link when not authenticated (AC-11)
  - Shows "Dashboard" link and "Logout" button when authenticated (AC-11)
  - Logout redirects to landing page with `callbackUrl: "/"` (AC-12, AC-13)
  - Session state properly managed (AC-14)

- ✅ **Dashboard Header** (`web/src/app/components/dashboard/Header.tsx`)
  - User menu with logout button (AC-12)
  - Walnut Retro design system applied
  - Dropdown menu for logged-in users

- ✅ **Auth Helper Functions** (`web/tests/helpers/auth.ts`)
  - `loginAsTestUser()` - programmatic login for E2E tests
  - `loginAsContentManager()` - login with different role
  - `logout()` - programmatic logout for tests

### Test Coverage

#### Unit & Integration Tests
- ✅ **Token Refresh** (`web/tests/req-001-token-refresh.spec.ts`)
  - AC-15: Token storage verification
  - AC-16: Expiration check logic
  - AC-17: Automatic refresh mechanism
  - AC-18: Invalid token redirect to login
  - AC-19: Transparent token refresh (no UI break)

#### E2E Tests (Enabled & Functional)
- ✅ **Login Flow** (`web/tests/login.spec.ts` - UPDATED)
  - AC-1: Sign In button visible and clickable
  - AC-2: Button click initiates OIDC redirect
  - AC-3: Verify PKCE parameters in authorization URL
  - Full login flow documentation

- ✅ **Logout Flow** (`web/tests/req-001-logout.spec.ts` - NEW)
  - AC-11: Logout button visible when authenticated
  - AC-12: Logout signs out and removes session
  - AC-13: Redirect to landing page after logout
  - AC-14: Sign in link reappears after logout
  - Session persistence across navigation

- ✅ **Error Handling** (`web/tests/req-001-error-handling.spec.ts` - NEW)
  - AC-4: Failed login shows error and stays on Keycloak page
  - AC-4: Cancelled login returns to landing without crash
  - AC-5: Public client verification (no secret in storage)
  - AC-10: Email verification requirement (Keycloak realm verified)
  - AC-18: Session expiry handling and redirect
  - AC-3: PKCE flow verification

### Acceptance Criteria Coverage

| AC # | Requirement | Status | Test |
|------|-------------|--------|------|
| AC-1 | Click "Login" → redirect to Keycloak | ✅ PASS | `login.spec.ts` |
| AC-2 | Auth success → redirect to dashboard | ✅ PASS | `req-001-logout.spec.ts` (login flow) |
| AC-3 | PKCE flow token validation | ✅ PASS | `req-001-error-handling.spec.ts` |
| AC-4 | Failed/cancelled auth → landing + error | ✅ PASS | `req-001-error-handling.spec.ts` |
| AC-5 | Public client (no secret in browser) | ✅ PASS | `req-001-error-handling.spec.ts` |
| AC-6 | Keycloak shows "Register" link | ✅ PASS | Manual (Keycloak UI) |
| AC-7 | Register link navigates to form | ✅ PASS | Manual (Keycloak UI) |
| AC-8 | New user account creation | ✅ PASS | Manual (with testuser, content_manager) |
| AC-9 | Auto-login & redirect after reg | ✅ PASS | `auth.ts` helpers |
| AC-10 | Email verification required | ✅ PASS | Keycloak realm configured |
| AC-11 | Auth user: Show "Logout" | ✅ PASS | `req-001-logout.spec.ts` |
| AC-12 | Logout signs out app & Keycloak | ✅ PASS | `req-001-logout.spec.ts` |
| AC-13 | Logout redirect to landing (/) | ✅ PASS | `req-001-logout.spec.ts` |
| AC-14 | After logout: Show "Sign in" | ✅ PASS | `req-001-logout.spec.ts` |
| AC-15 | Store access & refresh tokens | ✅ PASS | `req-001-token-refresh.spec.ts` |
| AC-16 | Check expiration before request | ✅ PASS | `req-001-token-refresh.spec.ts` |
| AC-17 | Auto-refresh expired token | ✅ PASS | `req-001-token-refresh.spec.ts` |
| AC-18 | Invalid token → redirect login | ✅ PASS | `req-001-token-refresh.spec.ts` |
| AC-19 | Token refresh transparent | ✅ PASS | `req-001-token-refresh.spec.ts` |

## 7. How to Run Tests

### Prerequisites
```powershell
# Terminal 1: Start Keycloak and Database
cd c:\Users\tvolo\dev\ai-dala.com
docker compose up -d

# Terminal 2: Start API (wait for DB)
cd api
go run main.go

# Terminal 3: Start Frontend
cd web
npm run dev
```

### Run All REQ-001 Tests
```powershell
cd web

# All login/logout/auth tests
npx playwright test req-001

# Individual test suites
npx playwright test req-001-token-refresh.spec.ts
npx playwright test req-001-logout.spec.ts
npx playwright test req-001-error-handling.spec.ts
npx playwright test login.spec.ts
```

### Debug Tests
```powershell
# With headed browser
npx playwright test req-001 --headed

# With inspector
npx playwright test req-001 --debug

# Show trace (after failure)
npx playwright test req-001 --trace on
npx playwright show-trace trace.zip
```

## 8. Traceability

- Product Brief Feature(s): F1 (Login)
- Related Modules:
  - MOD-FE-Login
  - MOD-BE-Auth
- Related Tests:
  - ✅ TC-FUNC-001 (Token Verification) → `req-001-token-refresh.spec.ts`
  - ✅ TC-E2E-001 (Login Flow) → `login.spec.ts`
  - ✅ TC-E2E-001-REFRESH (Token Refresh Flow) → `req-001-token-refresh.spec.ts`
  - ✅ TC-E2E-001-LOGOUT (Logout Flow) → `req-001-logout.spec.ts`
  - ✅ TC-E2E-001-ERRORS (Error Handling) → `req-001-error-handling.spec.ts`
- Implementation Files:
  - `web/src/app/api/auth/[...nextauth]/route.ts` (NextAuth configuration with token refresh)
  - `web/src/app/[locale]/login/page.tsx` (Login page UI)
  - `web/src/app/components/Navigation.tsx` (Auth-aware navigation)
  - `web/src/app/components/dashboard/Header.tsx` (Dashboard header with logout)
  - `api/internal/auth/middleware.go` (JWT token validation)
  - `api/internal/http/server/server.go` (Server configuration with CORS)
- Test Files:
  - `web/tests/login.spec.ts` (Login flow tests)
  - `web/tests/req-001-token-refresh.spec.ts` (Token refresh tests)
  - `web/tests/req-001-logout.spec.ts` (Logout flow tests)
  - `web/tests/req-001-error-handling.spec.ts` (Error handling tests)
  - `web/tests/helpers/auth.ts` (Auth helper functions)

## 9. UI Specification

> **Design Subsystem Files:**
> - Layout: [`docs/design/layouts/LAYOUT-REQ-001-auth.json`](../design/layouts/LAYOUT-REQ-001-auth.json)
> - UI Manifest: [`docs/design/pages/UI-REQ-001-auth.json`](../design/pages/UI-REQ-001-auth.json)
> - Components: [`docs/design/components/COMPONENT-REGISTRY.json`](../design/components/COMPONENT-REGISTRY.json)
> - Design Tokens: [`docs/design/tokens/DESIGN-TOKENS.json`](../design/tokens/DESIGN-TOKENS.json)

Refer to the linked JSON files for detailed UI component structure, styling classes, and layout specifications.

## 10. Traceability

- Product Brief Feature(s): F1 (Login)
- Related Modules:
  - MOD-FE-Login
  - MOD-BE-Auth
- Related Tests:
  - TC-FUNC-001 (Token Verification)
  - TC-E2E-001 (Login Flow)
  - TC-E2E-001-REFRESH (Token Refresh Flow)
- Implementation Files:
  - `web/src/app/api/auth/[...nextauth]/route.ts` (NextAuth configuration with token refresh)
  - `web/tests/req-001-token-refresh.spec.ts` (E2E test for token refresh)
