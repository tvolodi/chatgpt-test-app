# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-015
# VERSION: 1.0

## 1. Summary

- Title: Article Comments System
- Type: Functional
- Priority: high
- Status: **implemented**

## 2. Description

Users can leave comments on published articles to engage in discussions. Comments require authentication. The system supports threaded discussions and displays comments chronologically. Backend APIs already exist; this requirement documents the full specification.

## 3. User Stories

- **US-15.1**: As a visitor, I want to read comments on an article to see community discussions.
- **US-15.2**: As an authenticated user, I want to post a comment on an article to share my thoughts.
- **US-15.3**: As a comment author, I want to see my comment displayed immediately after posting.
- **US-15.4**: As a visitor, I want to see when comments were posted to understand the discussion timeline.
- **US-15.5**: As a visitor, I want to see who wrote each comment.

## 4. Technical Specifications

### 4.1 Backend API (Already Implemented)

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/articles/{id}/comments` | No | Get all comments for an article |
| POST | `/api/articles/{id}/comments` | Yes | Add a new comment |

### 4.2 Request/Response Schemas

**POST /api/articles/{id}/comments**
```json
Request:
{
  "body": "string (required)"
}

Response (201):
{
  "id": "uuid",
  "article_id": "uuid",
  "user_id": "uuid",
  "body": "string",
  "created_at": "datetime"
}
```

**GET /api/articles/{id}/comments**
```json
Response (200):
{
  "comments": [
    {
      "id": "uuid",
      "article_id": "uuid",
      "user_id": "uuid",
      "body": "string",
      "created_at": "datetime"
    }
  ]
}
```

### 4.3 Database Schema

```sql
CREATE TABLE article_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_id UUID NOT NULL REFERENCES articles(id),
  user_id UUID NOT NULL,
  body TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 4.4 Frontend Components

| Component | Location | Description |
|-----------|----------|-------------|
| `CommentSection` | `web/src/components/articles/CommentSection.tsx` | Container for comments display |
| `CommentForm` | `web/src/components/articles/CommentForm.tsx` | Form for posting new comments |
| `CommentItem` | `web/src/components/articles/CommentItem.tsx` | Single comment display |

## 5. Wireframes

```
┌─────────────────────────────────────────────────────────────┐
│ Article Content                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Comments (3)                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [Avatar] John Doe                        2 hours ago    │ │
│ │ Great article! Very informative.                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ [Avatar] Jane Smith                      1 day ago      │ │
│ │ Thanks for sharing this perspective.                    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [Login to comment] (if not authenticated)                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Write a comment...                                      │ │
│ │                                                         │ │
│ │                                          [Post Comment] │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 6. Acceptance Criteria

### AC-15.1: Comment Display
- **AC-15.1.1**: Comments section shows total comment count
- **AC-15.1.2**: Each comment displays author name (or "Anonymous" if not available)
- **AC-15.1.3**: Each comment displays relative timestamp (e.g., "2 hours ago")
- **AC-15.1.4**: Comments are ordered by creation date (newest first or oldest first)
- **AC-15.1.5**: Empty state shows appropriate message when no comments exist

### AC-15.2: Comment Posting
- **AC-15.2.1**: Comment form is only visible to authenticated users
- **AC-15.2.2**: Unauthenticated users see "Login to comment" message
- **AC-15.2.3**: Comment body is required (validation error if empty)
- **AC-15.2.4**: Comment body has maximum length (e.g., 2000 characters)
- **AC-15.2.5**: Submit button is disabled while posting
- **AC-15.2.6**: New comment appears in list immediately after successful post
- **AC-15.2.7**: Form is cleared after successful post

### AC-15.3: Error Handling
- **AC-15.3.1**: Network errors display user-friendly error message
- **AC-15.3.2**: Validation errors are displayed near the form field
- **AC-15.3.3**: Session expiration prompts re-authentication

### AC-15.4: i18n Support
- **AC-15.4.1**: All UI text uses translation keys
- **AC-15.4.2**: Relative timestamps are localized

## 7. Dependencies

| REQ_ID | Description |
|--------|-------------|
| REQ-001 | User login (for authenticated commenting) |
| REQ-013 | Article view (comments displayed on article page) |

## 8. Test Traceability

| Test ID | Type | Acceptance Criteria |
|---------|------|---------------------|
| TC-E2E-015.1 | E2E | AC-15.1.1, AC-15.1.2, AC-15.1.3 |
| TC-E2E-015.2 | E2E | AC-15.2.1, AC-15.2.2 |
| TC-E2E-015.3 | E2E | AC-15.2.3, AC-15.2.6, AC-15.2.7 |
| TC-INT-015.1 | Integration | Backend comment CRUD operations |

## 9. Implementation Notes

### For AI Agents

1. **Backend Status**: APIs already implemented in `api/internal/modules/articles/handler.go`
2. **Frontend Focus**: Main work is UI components and integration
3. **User Name Resolution**: User names must be fetched from Keycloak or stored locally
4. **Optimistic Updates**: Consider showing comment immediately before API confirms
