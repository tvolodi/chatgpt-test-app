# DOCUMENT_TYPE: REQUIREMENT
# REQ_ID: REQ-014
# VERSION: 1.0

## 1. Summary

- Title: User Profile & Settings
- Type: Functional
- Priority: medium
- Status: **approved**

## 2. Description

Authenticated users need a profile page to view and manage their account information. This includes viewing their Keycloak-managed profile data, managing display preferences, and customizing their experience on the platform.

Since authentication is managed by Keycloak, the profile page will display read-only information from the OIDC token and provide links to Keycloak's account management portal for editing sensitive data.

## 3. User Stories

- **US-14.1**: As an authenticated user, I want to view my profile information (name, email, avatar) so I can verify my account details.
- **US-14.2**: As an authenticated user, I want to access Keycloak's account management to update my password and personal information.
- **US-14.3**: As an authenticated user, I want to select my preferred language for the interface.
- **US-14.4**: As an authenticated user, I want to view my recent activity (articles I've liked, comments I've made).
- **US-14.5**: As an authenticated user, I want to manage my notification preferences.

## 4. Technical Specifications

### 4.1 Frontend Routes

| Route | Description |
|-------|-------------|
| `/[locale]/dashboard/profile` | User profile page |
| `/[locale]/dashboard/settings` | User settings page |

### 4.2 Profile Data Sources

| Field | Source | Editable |
|-------|--------|----------|
| Name | OIDC token (`preferred_username`, `given_name`, `family_name`) | Via Keycloak |
| Email | OIDC token (`email`) | Via Keycloak |
| Avatar | OIDC token (`picture`) or Gravatar fallback | Via Keycloak |
| Roles | OIDC token (`realm_access.roles`) | Admin only |
| Preferred Language | Browser localStorage / cookie | Yes |

### 4.3 Keycloak Integration

```
Keycloak Account Management URL:
{KEYCLOAK_BASE_URL}/realms/{REALM}/account
```

### 4.4 Local Preferences Storage

```typescript
interface UserPreferences {
  locale: 'en' | 'ru' | 'kk';
  theme?: 'light' | 'dark' | 'system';
  notificationsEnabled?: boolean;
}
```

Store in `localStorage` with key `user_preferences`.

### 4.5. Backend API Additions

**New endpoints needed for user activity:**

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/user/activity` | Get user's recent likes and comments |

**Response format:**
```json
{
  "likes": [
    {
      "article_id": "uuid",
      "article_title": "Article Title",
      "is_like": true,
      "created_at": "2024-01-01T00:00:00Z"
    }
  ],
  "comments": [
    {
      "id": "uuid",
      "article_id": "uuid", 
      "article_title": "Article Title",
      "body": "Comment text...",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**Activity Scope**: Limited to last 30 days, showing maximum 10 most recent items per type.

### 4.6. Avatar Fallback Logic

```typescript
// Priority order for avatar display:
1. OIDC token `picture` field (if available)
2. Gravatar based on email hash (if email available)
3. Default user icon
```

### 4.7. Role Display Mapping

```typescript
const ROLE_DISPLAY_NAMES = {
  'content-manager': 'Content Manager',
  'admin': 'Administrator',
  'user': 'User',
  'editor': 'Editor'
};
```

## 5. Wireframes

```
┌─────────────────────────────────────────────────────────────┐
│ Dashboard Header                                     [User] │
├───────────────┬─────────────────────────────────────────────┤
│               │                                             │
│   Sidebar     │   Profile                                   │
│               │   ┌───────────────────────────────────┐     │
│   [Dashboard] │   │  ┌─────┐                          │     │
│   [Articles]  │   │  │Avatar│  John Doe               │     │
│   [Tags]      │   │  └─────┘  john@example.com       │     │
│   [Categories]│   │           Roles: content-manager  │     │
│   ─────────── │   │                                   │     │
│   [Profile] ← │   │  [Edit in Keycloak →]            │     │
│   [Settings]  │   └───────────────────────────────────┘     │
│               │                                             │
│               │   Recent Activity                           │
│               │   ┌───────────────────────────────────┐     │
│               │   │ • Liked "AI in Healthcare" - 2h   │     │
│               │   │ • Commented on "Tech News" - 1d   │     │
│               │   └───────────────────────────────────┘     │
│               │                                             │
└───────────────┴─────────────────────────────────────────────┘
```

## 6. Acceptance Criteria

### AC-14.1: Profile Display
- **AC-14.1.1**: Profile page displays user's name from OIDC token
- **AC-14.1.2**: Profile page displays user's email from OIDC token
- **AC-14.1.3**: Profile page displays user's avatar (from token or Gravatar fallback)
- **AC-14.1.4**: Profile page displays user's roles in human-readable format
- **AC-14.1.5**: Profile page is accessible only to authenticated users

### AC-14.2: Keycloak Integration
- **AC-14.2.1**: "Edit in Keycloak" button links to Keycloak account management
- **AC-14.2.2**: Link opens in new tab with proper security attributes

### AC-14.3: Language Preference
- **AC-14.3.1**: Settings page shows language selector with en/ru/kk options
- **AC-14.3.2**: Language change persists in localStorage
- **AC-14.3.3**: Language change immediately updates UI locale

### AC-14.4: Activity Display
- **AC-14.4.1**: Profile shows recent likes (if likes feature implemented)
- **AC-14.4.2**: Profile shows recent comments (if comments feature implemented)
- **AC-14.4.3**: Activity items link to original content

### AC-14.5: Accessibility & i18n
- **AC-14.5.1**: All text uses translation keys from `messages/*.json`
- **AC-14.5.2**: Page meets WCAG 2.1 AA accessibility standards
- **AC-14.5.3**: Sidebar shows Profile and Settings menu items

## 7. Dependencies

| REQ_ID | Description |
|--------|-------------|
| REQ-001 | User login via Keycloak (provides OIDC tokens) |
| REQ-004 | Dashboard layout (provides page structure) |
| REQ-005 | Sidebar navigation (needs Profile/Settings links) |
| REQ-006 | i18n support (for language selector) |

## 8. Test Traceability

| Test ID | Type | Acceptance Criteria | Test File |
|---------|------|---------------------|-----------|
| TC-E2E-014.1 | E2E | AC-14.1.1, AC-14.1.2, AC-14.1.3, AC-14.1.4, AC-14.1.5 | `web/tests/req-014-profile-display.spec.ts` |
| TC-E2E-014.2 | E2E | AC-14.2.1, AC-14.2.2 | `web/tests/req-014-keycloak-integration.spec.ts` |
| TC-E2E-014.3 | E2E | AC-14.3.1, AC-14.3.2, AC-14.3.3 | `web/tests/req-014-language-preference.spec.ts` |
| TC-E2E-014.4 | E2E | AC-14.4.1, AC-14.4.2, AC-14.4.3 | `web/tests/req-014-activity-display.spec.ts` |
| TC-INT-014.1 | Integration | User activity API | `api/internal/modules/user/service_test.go` |

## 9. UI Specification

> **Design Subsystem Files:**
> - UI Manifest: [`docs/design/pages/UI-REQ-004-dashboard.json`](../design/pages/UI-REQ-004-dashboard.json) (Profile page section)
> - Components: [`docs/design/components/COMPONENT-REGISTRY.json`](../design/components/COMPONENT-REGISTRY.json)
> - Design Tokens: [`docs/design/tokens/DESIGN-TOKENS.json`](../design/tokens/DESIGN-TOKENS.json)

Refer to the linked JSON files for detailed UI component structure, styling classes, and layout specifications.

## 10. Implementation Notes

### For AI Agents

1. **Phase 1 Check**: Verify this requirement is approved before implementing
2. **Component Location**: 
   - Profile: `web/src/app/[locale]/dashboard/profile/page.tsx`
   - Settings: `web/src/app/[locale]/dashboard/settings/page.tsx` (refactor existing)
3. **Token Access**: Use `useSession()` from next-auth to access OIDC token claims
4. **Backend API Needed**: Add user activity endpoint (`/api/user/activity`)
5. **Sidebar Update**: Add "Profile" link to sidebar navigation
6. **Activity Feature**: Implement using existing likes/comments tables
7. **Gravatar**: Use crypto-js MD5 for email hashing
8. **i18n**: Update `messages/*.json` with new translation keys
